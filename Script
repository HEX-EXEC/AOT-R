local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")
local VIM = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")

local Titans = Workspace:WaitForChild("Titans")
local Remotes = ReplicatedStorage:WaitForChild("Assets"):WaitForChild("Remotes")

print("Start praying cause idk if this works :)")

-- Function to disable collisions
local function disableCollisions()
    for _, part in ipairs(Character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = false
        end
    end
end

-- Function to find the closest Titan nape
local function findClosestNape()
    local closestNape, closestHumanoid, closestDist = nil, nil, math.huge

    for _, Titan in ipairs(Titans:GetChildren()) do
        if Titan:IsA("Model") then
            local Humanoid = Titan:FindFirstChild("Humanoid")

            if Humanoid then
                for _, Obj in ipairs(Titan:GetDescendants()) do
                    if Obj.Name == "Nape" and Obj:IsA("BasePart") then
                        local Dist = (HRP.Position - Obj.Position).Magnitude

                        if Dist < closestDist then
                            closestDist = Dist
                            closestNape = Obj
                            closestHumanoid = Humanoid
                        end
                    end
                end
            end
        end
    end

    return closestNape, closestHumanoid
end

-- Skill usage loop
local function skillUsageLoop()
    while true do
        Remotes.GET:InvokeServer("S_Skills", "Usage", "23")
        task.wait(0.002)
        Remotes.GET:InvokeServer("S_Skills", "Usage", "14")
        task.wait(3)
        local closestNape, closestHumanoid = findClosestNape()
        if closestNape and closestHumanoid and closestHumanoid.Parent then
            mainLoop(closestNape, closestHumanoid)
        end
    end
end

-- Main loop for farming
function mainLoop(closestNape, closestHumanoid)
    while closestNape and closestHumanoid and closestHumanoid.Parent do
        Remotes.POST:FireServer("Attacks", "Slash", true)
        Remotes.GET:InvokeServer("Hitboxes", "Register", closestNape, math.random(225000, 230000), math.random(500000, 1000000))
        closestNape, closestHumanoid = findClosestNape()
    end
end

-- Auto Retry Function
local function autoRetry()
    local lastRetryTime = os.time() -- Track the last retry time

    while true do -- Main loop for autoRetry
        if G_Retry then -- Only run when G_Retry is true
            local currentTime = os.time()
            local closestNape, closestHumanoid = findClosestNape()

            if not closestNape then
                -- Wait for G_Delay seconds and check if nape reappears
                for i = 1, G_Delay * 10 do
                    task.wait(0.1) -- Wait in small increments
                    closestNape, closestHumanoid = findClosestNape()
                    if closestNape then
                        break -- Cancel retry if nape reappears
                    end
                end

                -- If nape still not found after delay, send retry request
                if not closestNape then
                    Remotes.GET:InvokeServer("Functions", "Retry", "Add")
                    lastRetryTime = os.time()
                end
            end
        elseif G_ForceRetry then -- Only run force retry when G_Retry is false
            local currentTime = os.time()

            -- Wait for G_Delay seconds
            task.wait(G_Delay)

            -- Force retry
            Remotes.GET:InvokeServer("Functions", "Retry", "Add")
            lastRetryTime = os.time()
        end

        task.wait(0.1) -- Small wait to prevent tight loop
    end
end

-- Initialize player data
task.spawn(function()
    local Player = Players.LocalPlayer
    local Character = Player.Character or Player.CharacterAdded:Wait()
    local Humanoid = Character:WaitForChild("Humanoid")
    local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
    local Titans = Workspace:WaitForChild("Titans")
    local Remotes = ReplicatedStorage:WaitForChild("Assets"):WaitForChild("Remotes")

    -- Position Nape to HumanoidRootPart
    task.spawn(function()
        while true do
            for _, titan in ipairs(Titans:GetChildren()) do
                if titan:IsA("Model") then
                    for _, part in ipairs(titan:GetDescendants()) do
                        if part:IsA("BasePart") and part.Name == "Nape" then
                            local offset = part.Position - titan.PrimaryPart.Position
                            part.CFrame = HumanoidRootPart.CFrame:ToWorldSpace(CFrame.new(offset))
                            part.CanCollide = false
                        end
                    end
                end
            end
            task.wait(0.01)
        end
    end)
end)

-- Run the script
local function runAutoFarm()
    disableCollisions()
    task.spawn(skillUsageLoop) -- Start skill usage loop in parallel
    task.spawn(autoRetry) -- Start auto retry in parallel
end

-- Ensure Titans are loaded before starting the auto farm
local function waitForNapes()
    while not findClosestNape() do
        task.wait(0.1)
    end
end

-- AutoBlade function
local function autoBlade()
    while task.wait() do
        if not G_Reload then return end -- Check the toggle variable
        local character = game.Players.LocalPlayer.Character
        if character then
            local rig = character:FindFirstChild("Rig_"..game.Players.LocalPlayer.Name)
            if rig then
                for i,v in pairs(rig:GetChildren() or {}) do
                    if v.Name == "RightHand" or v.Name == "LeftHand" then
                        for i2,v2 in pairs(v:GetChildren() or {}) do
                            if v2.Name == "Blade_1" then
                                local broken = v2:GetAttribute("Broken")
                                if broken ~= nil and broken == true then
                                    pcall(function()
                                        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.R, false, game)
                                        task.wait(0.1)
                                        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.R, false, game)
                                    end)
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

-- AutoEscape function
local function autoEscape()
    while task.wait(0.3) do
        if not G_Escape then return end -- Check the toggle variable
        for i,v in pairs(game:GetService("Players").LocalPlayer.PlayerGui.Interface.Buttons:GetChildren()) do
            if v ~= nil then
                VIM:SendKeyEvent(true, string.sub(tostring(v), 1, 1), false, game)
            end
        end
    end
end

-- Start the auto farm when napes are loaded
waitForNapes()
runAutoFarm()
task.spawn(autoBlade) -- Start AutoBlade in parallel
task.spawn(autoEscape) -- Start AutoEscape in parallel

print("Everything works... I think...")
